<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>陀螺仪</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { background: white; padding: 20px; border-radius: 10px; text-align: center; }
        .data { margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; }
        .value { font-weight: bold; color: #007bff; font-size: 24px; }
        .status { color: #dc3545; font-weight: bold; margin: 10px 0; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:disabled { background: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <h2>陀螺仪</h2>
        <div id="status" class="status">点击启动</div>
        <button id="startBtn">启动陀螺仪</button>
        
        <div class="data">俯仰角：<span id="pitch" class="value">3600</span>°</div>
        <div class="data">横滚角：<span id="roll" class="value">3600</span>°</div>
        <div class="data">偏航角：<span id="yaw" class="value">3600</span>°</div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const startBtn = document.getElementById('startBtn');
        
        // 累计角度变量（初始值3600）
        let pitchTotal = 3600;  // 俯仰累计值
        let rollTotal = 3600;   // 横滚累计值
        let yawTotal = 3600;    // 偏航累计值
        
        // 上一次的原始角度（用于计算差值）
        let prevBeta = null;
        let prevGamma = null;
        let prevAlpha = null;
        
        // 修正角度跳变的核心函数：计算连续差值
        function calculateDelta(current, previous, maxRange, threshold) {
            if (previous === null) return 0; // 首次无差值
            
            let delta = current - previous;
            // 处理跳变：差值绝对值超过阈值时，修正为反向小差值
            if (Math.abs(delta) > threshold) {
                delta = delta > 0 ? delta - maxRange : delta + maxRange;
            }
            return delta;
        }

        function startGyro() {
            if (!window.DeviceOrientationEvent) {
                statusEl.textContent = '设备不支持';
                return;
            }
            
            statusEl.textContent = '启动中...';
            startBtn.disabled = true;
            
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(permission => {
                    if (permission === 'granted') startSensors();
                    else statusEl.textContent = '权限被拒绝';
                }).catch(() => statusEl.textContent = '权限请求失败');
            } else {
                startSensors();
            }
        }
        
        function startSensors() {
            let hasData = false;
            
            window.addEventListener('deviceorientation', (event) => {
                // 原始角度值（处理null情况）
                const beta = event.beta ?? 0;     // 俯仰原始值：-180 ~ 180
                const gamma = event.gamma ?? 0;   // 横滚原始值：-90 ~ 90
                const alpha = event.alpha ?? 0;   // 偏航原始值：0 ~ 360

                if (!hasData) {
                    // 首次获取数据：初始化上一次值，标记已获取
                    prevBeta = beta;
                    prevGamma = gamma;
                    prevAlpha = alpha;
                    hasData = true;
                    statusEl.textContent = '数据读取中';
                    return;
                }

                // ========== 1. 俯仰角（beta）修正：-180~180 → 累计无跳变 ==========
                const betaDelta = calculateDelta(beta, prevBeta, 360, 180);
                pitchTotal += betaDelta;
                prevBeta = beta;

                // ========== 2. 横滚角（gamma）修正：-90~90 → 累计无跳变 ==========
                const gammaDelta = calculateDelta(gamma, prevGamma, 180, 90);
                rollTotal += gammaDelta;
                prevGamma = gamma;

                // ========== 3. 偏航角（alpha）修正：0~360 → 累计无跳变 ==========
                const alphaDelta = calculateDelta(alpha, prevAlpha, 360, 180);
                yawTotal += alphaDelta;
                prevAlpha = alpha;

                // 更新显示（保留1位小数）
                document.getElementById('pitch').textContent = pitchTotal.toFixed(1);
                document.getElementById('roll').textContent = rollTotal.toFixed(1);
                document.getElementById('yaw').textContent = yawTotal.toFixed(1);
            });
            
            setTimeout(() => {
                if (!hasData) {
                    statusEl.textContent = '启动失败，请重试';
                    startBtn.disabled = false;
                    startBtn.textContent = '重试';
                }
            }, 3000);
        }
        
        startBtn.addEventListener('click', startGyro);
    </script>
</body>
</html>
