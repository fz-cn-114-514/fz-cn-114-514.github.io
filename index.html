<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>舵机陀螺仪控制</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            padding: 10px;
            background-color: #f5f5f5;
        }
        /* 开关样式 */
        .switch-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .switch-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .switch {
            position: relative;
            width: 60px;
            height: 30px;
            background-color: #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .switch.on {
            background-color: #4CAF50;
        }
        .switch::after {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background-color: white;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }
        .switch.on::after {
            left: 32px;
        }
        .switch-label {
            position: absolute;
            font-size: 12px;
            color: white;
            top: 50%;
            transform: translateY(-50%);
        }
        .switch-label.on {
            left: 8px;
        }
        .switch-label.off {
            right: 8px;
        }

        /* 映射归零按钮 */
        .reset-btn {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .reset-btn:active {
            background-color: #ff0000;
        }

        /* 通道参数区 */
        .channel-container {
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .channel-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .channel-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 5px;
            margin-bottom: 5px;
        }
        .param-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .param-item label {
            font-size: 12px;
            color: #666;
        }
        .param-item input {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            text-align: center;
        }
        .param-item span {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background-color: #f9f9f9;
            text-align: center;
        }

        /* 状态参数栏 */
        .status-container {
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .status-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .status-label {
            font-weight: bold;
        }
        .status-value {
            color: #666;
        }

        /* 说明区 */
        .desc-container {
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 12px;
            color: #666;
        }

        /* 调试信息区 */
        .debug-container {
            background-color: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            height: 150px;
            overflow: hidden;
            font-size: 12px;
            position: relative;
        }
        .debug-content {
            position: absolute;
            bottom: 0;
            width: 100%;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <!-- 开关区 -->
    <div class="switch-group">
        <div class="switch-item">
            <span>启用控制</span>
            <div class="switch on" id="ctrl-switch">
                <span class="switch-label on">ON</span>
                <span class="switch-label off">OFF</span>
            </div>
        </div>
        <div class="switch-item">
            <span>操作解锁</span>
            <div class="switch on" id="lock-switch">
                <span class="switch-label on">ON</span>
                <span class="switch-label off">OFF</span>
            </div>
        </div>
        <div class="switch-item">
            <span>陀螺仪开关</span>
            <div class="switch" id="gyro-switch">
                <span class="switch-label on">ON</span>
                <span class="switch-label off">OFF</span>
            </div>
        </div>
    </div>

    <!-- 映射归零按钮 -->
    <button class="reset-btn" id="reset-btn">映射归零</button>

    <!-- 通道参数区（P/R/Y三轴） -->
    <div class="channel-container">
        <div class="channel-title">俯仰通道（P）</div>
        <div class="channel-row">
            <div class="param-item">
                <label>传感器原数值</label>
                <span id="p-raw">0</span>
            </div>
            <div class="param-item">
                <label>映射角度</label>
                <span id="p-mapped">0</span>
            </div>
            <div class="param-item">
                <label>映射引脚</label>
                <input type="number" id="p-pin" value="11" disabled>
            </div>
            <div class="param-item">
                <label>每度脉宽(rate)</label>
                <input type="number" id="p-rate" value="10" disabled>
            </div>
        </div>
        <div class="channel-row">
            <div class="param-item">
                <label>最小脉宽</label>
                <input type="number" id="p-min" value="500" disabled>
            </div>
            <div class="param-item">
                <label>输出脉宽</label>
                <span id="p-pwm">1500</span>
            </div>
            <div class="param-item">
                <label>0度脉宽</label>
                <input type="number" id="p-zero" value="1500" disabled>
            </div>
            <div class="param-item">
                <label>最大脉宽</label>
                <input type="number" id="p-max" value="2500" disabled>
            </div>
        </div>
    </div>

    <div class="channel-container">
        <div class="channel-title">横滚通道（R）</div>
        <div class="channel-row">
            <div class="param-item">
                <label>传感器原数值</label>
                <span id="r-raw">0</span>
            </div>
            <div class="param-item">
                <label>映射角度</label>
                <span id="r-mapped">0</span>
            </div>
            <div class="param-item">
                <label>映射引脚</label>
                <input type="number" id="r-pin" value="12" disabled>
            </div>
            <div class="param-item">
                <label>每度脉宽(rate)</label>
                <input type="number" id="r-rate" value="10" disabled>
            </div>
        </div>
        <div class="channel-row">
            <div class="param-item">
                <label>最小脉宽</label>
                <input type="number" id="r-min" value="500" disabled>
            </div>
            <div class="param-item">
                <label>输出脉宽</label>
                <span id="r-pwm">1500</span>
            </div>
            <div class="param-item">
                <label>0度脉宽</label>
                <input type="number" id="r-zero" value="1500" disabled>
            </div>
            <div class="param-item">
                <label>最大脉宽</label>
                <input type="number" id="r-max" value="2500" disabled>
            </div>
        </div>
    </div>

    <div class="channel-container">
        <div class="channel-title">偏航通道（Y）</div>
        <div class="channel-row">
            <div class="param-item">
                <label>传感器原数值</label>
                <span id="y-raw">0</span>
            </div>
            <div class="param-item">
                <label>映射角度</label>
                <span id="y-mapped">0</span>
            </div>
            <div class="param-item">
                <label>映射引脚</label>
                <input type="number" id="y-pin" value="13" disabled>
            </div>
            <div class="param-item">
                <label>每度脉宽(rate)</label>
                <input type="number" id="y-rate" value="10" disabled>
            </div>
        </div>
        <div class="channel-row">
            <div class="param-item">
                <label>最小脉宽</label>
                <input type="number" id="y-min" value="500" disabled>
            </div>
            <div class="param-item">
                <label>输出脉宽</label>
                <span id="y-pwm">1500</span>
            </div>
            <div class="param-item">
                <label>0度脉宽</label>
                <input type="number" id="y-zero" value="1500" disabled>
            </div>
            <div class="param-item">
                <label>最大脉宽</label>
                <input type="number" id="y-max" value="2500" disabled>
            </div>
        </div>
    </div>

    <!-- 状态参数栏 -->
    <div class="status-container">
        <div class="status-row">
            <span class="status-label">WiFi信息</span>
            <span class="status-value" id="wifi-info">未连接 / -</span>
        </div>
        <div class="status-row">
            <span class="status-label">浏览器信息</span>
            <span class="status-value" id="browser-info">- / v1.0</span>
        </div>
        <div class="status-row">
            <span class="status-label">硬件信息</span>
            <span class="status-value" id="hardware-info">未开启 / P:0, R:0, Y:0</span>
        </div>
        <div class="status-row">
            <span class="status-label">界面信息</span>
            <span class="status-value" id="ui-info">- / 100Hz / 0ms</span>
        </div>
    </div>

    <!-- 说明区 -->
    <div class="desc-container">
        <h4>使用说明</h4>
        <p>1. 陀螺仪开关开启后读取手机三轴数据，映射归零后以当前值为0度基准</p>
        <p>2. 输出脉宽计算公式：输出脉宽=0度脉宽+rate×映射角度，且不超过最小/最大脉宽限制</p>
        <p>3. 操作解锁关闭后，仅可操作解锁开关，其余控件不可点击</p>
        <h4>注意事项</h4>
        <p>1. 确保手机开启陀螺仪权限</p>
        <p>2. WiFi连接后才能向ESP32下发数据</p>
        <p>3. 舵机脉宽范围建议500-2500us，避免超出硬件极限</p>
    </div>

    <!-- 调试信息区 -->
    <div class="debug-container">
        <div class="debug-content" id="debug-content"></div>
    </div>

    <script>
        // 全局状态
        const state = {
            // 开关状态
            ctrlEnabled: true,
            lockUnlocked: true,
            gyroEnabled: false,
            // 映射归零基准值
            resetBase: { p: 0, r: 0, y: 0 },
            // 陀螺仪原始数据
            gyroRaw: { p: 0, r: 0, y: 0 },
            // WebSocket连接
            ws: null,
            // 延迟统计
            lastSendTime: 0,
            delay: 0,
            // 码率统计
            sendCount: 0,
            lastRateTime: Date.now()
        };

        // DOM元素
        const els = {
            // 开关
            ctrlSwitch: document.getElementById('ctrl-switch'),
            lockSwitch: document.getElementById('lock-switch'),
            gyroSwitch: document.getElementById('gyro-switch'),
            // 按钮
            resetBtn: document.getElementById('reset-btn'),
            // 通道参数
            pRaw: document.getElementById('p-raw'),
            pMapped: document.getElementById('p-mapped'),
            pPin: document.getElementById('p-pin'),
            pRate: document.getElementById('p-rate'),
            pMin: document.getElementById('p-min'),
            pPwm: document.getElementById('p-pwm'),
            pZero: document.getElementById('p-zero'),
            pMax: document.getElementById('p-max'),
            rRaw: document.getElementById('r-raw'),
            rMapped: document.getElementById('r-mapped'),
            rPin: document.getElementById('r-pin'),
            rRate: document.getElementById('r-rate'),
            rMin: document.getElementById('r-min'),
            rPwm: document.getElementById('r-pwm'),
            rZero: document.getElementById('r-zero'),
            rMax: document.getElementById('r-max'),
            yRaw: document.getElementById('y-raw'),
            yMapped: document.getElementById('y-mapped'),
            yPin: document.getElementById('y-pin'),
            yRate: document.getElementById('y-rate'),
            yMin: document.getElementById('y-min'),
            yPwm: document.getElementById('y-pwm'),
            yZero: document.getElementById('y-zero'),
            yMax: document.getElementById('y-max'),
            // 状态信息
            wifiInfo: document.getElementById('wifi-info'),
            browserInfo: document.getElementById('browser-info'),
            hardwareInfo: document.getElementById('hardware-info'),
            uiInfo: document.getElementById('ui-info'),
            // 调试信息
            debugContent: document.getElementById('debug-content')
        };

        // 初始化浏览器信息
        function initBrowserInfo() {
            const ua = navigator.userAgent;
            let kernel = '未知';
            if (ua.includes('Chrome')) kernel = 'Chrome';
            else if (ua.includes('Safari')) kernel = 'Safari';
            else if (ua.includes('Firefox')) kernel = 'Firefox';
            els.browserInfo.textContent = `${kernel} / v1.0`;
        }

        // 开关切换逻辑
        function initSwitches() {
            // 启用控制开关
            els.ctrlSwitch.addEventListener('click', () => {
                if (!state.lockUnlocked) return;
                state.ctrlEnabled = !state.ctrlEnabled;
                els.ctrlSwitch.classList.toggle('on', state.ctrlEnabled);
                addDebug(`启用控制${state.ctrlEnabled ? '开启' : '关闭'}`);
            });

            // 操作解锁开关
            els.lockSwitch.addEventListener('click', () => {
                state.lockUnlocked = !state.lockUnlocked;
                els.lockSwitch.classList.toggle('on', state.lockUnlocked);
                // 解锁/锁定输入框
                const inputs = document.querySelectorAll('input');
                inputs.forEach(input => {
                    input.disabled = !state.lockUnlocked;
                });
                addDebug(`操作解锁${state.lockUnlocked ? '开启' : '关闭'}`);
            });

            // 陀螺仪开关
            els.gyroSwitch.addEventListener('click', () => {
                if (!state.lockUnlocked) return;
                state.gyroEnabled = !state.gyroEnabled;
                els.gyroSwitch.classList.toggle('on', state.gyroEnabled);
                if (state.gyroEnabled) {
                    startGyro();
                    addDebug('陀螺仪开启');
                } else {
                    stopGyro();
                    addDebug('陀螺仪关闭');
                }
            });
        }

        // 映射归零按钮逻辑
        function initResetBtn() {
            els.resetBtn.addEventListener('click', () => {
                if (!state.lockUnlocked || !state.gyroEnabled) return;
                state.resetBase = { ...state.gyroRaw };
                addDebug(`映射归零，基准值：P=${state.resetBase.p}, R=${state.resetBase.r}, Y=${state.resetBase.y}`);
                // 重新计算映射角度
                calculateMappedAngle();
            });
        }

        // 启动陀螺仪监听
        function startGyro() {
            if (!window.DeviceOrientationEvent) {
                addDebug('当前浏览器不支持陀螺仪');
                return;
            }
            // 请求权限（部分浏览器需要）
            DeviceOrientationEvent.requestPermission?.().then(permission => {
                if (permission !== 'granted') {
                    addDebug('陀螺仪权限被拒绝');
                    state.gyroEnabled = false;
                    els.gyroSwitch.classList.remove('on');
                    return;
                }
                window.addEventListener('deviceorientation', handleGyroData);
                els.hardwareInfo.textContent = `已开启 / P:0, R:0, Y:0`;
            }).catch(err => {
                addDebug(`陀螺仪权限请求失败：${err}`);
            });
        }

        // 停止陀螺仪监听
        function stopGyro() {
            window.removeEventListener('deviceorientation', handleGyroData);
            els.hardwareInfo.textContent = `未开启 / P:0, R:0, Y:0`;
        }

        // 处理陀螺仪数据
        function handleGyroData(e) {
            if (!state.gyroEnabled) return;
            // 获取三轴数据（alpha:偏航, beta:俯仰, gamma:横滚）
            const p = e.beta || 0; // 俯仰
            const r = e.gamma || 0; // 横滚
            const y = e.alpha || 0; // 偏航
            state.gyroRaw = { p, r, y };

            // 更新原始数值显示
            els.pRaw.textContent = p.toFixed(2);
            els.rRaw.textContent = r.toFixed(2);
            els.yRaw.textContent = y.toFixed(2);

            // 更新硬件信息
            els.hardwareInfo.textContent = `已开启 / P:${p.toFixed(2)}, R:${r.toFixed(2)}, Y:${y.toFixed(2)}`;

            // 计算映射角度
            calculateMappedAngle();

            // 计算输出脉宽
            calculatePwm();

            // 下发数据到ESP32
            sendToESP32();
        }

        // 计算映射角度（当前值 - 基准值）
        function calculateMappedAngle() {
            const pMapped = (state.gyroRaw.p - state.resetBase.p).toFixed(2);
            const rMapped = (state.gyroRaw.r - state.resetBase.r).toFixed(2);
            const yMapped = (state.gyroRaw.y - state.resetBase.y).toFixed(2);

            // 更新映射角度显示
            els.pMapped.textContent = pMapped;
            els.rMapped.textContent = rMapped;
            els.yMapped.textContent = yMapped;
        }

        // 计算输出脉宽
        function calculatePwm() {
            // 俯仰通道
            const pZero = parseFloat(els.pZero.value);
            const pRate = parseFloat(els.pRate.value);
            const pMapped = parseFloat(els.pMapped.textContent);
            let pPwm = pZero + pRate * pMapped;
            const pMin = parseFloat(els.pMin.value);
            const pMax = parseFloat(els.pMax.value);
            pPwm = Math.max(pMin, Math.min(pMax, pPwm));
            els.pPwm.textContent = pPwm.toFixed(0);

            // 横滚通道
            const rZero = parseFloat(els.rZero.value);
            const rRate = parseFloat(els.rate.value);
            const rMapped = parseFloat(els.rMapped.textContent);
            let rPwm = rZero + rRate * rMapped;
            const rMin = parseFloat(els.rMin.value);
            const rMax = parseFloat(els.rMax.value);
            rPwm = Math.max(rMin, Math.min(rMax, rPwm));
            els.rPwm.textContent = rPwm.toFixed(0);

            // 偏航通道
            const yZero = parseFloat(els.yZero.value);
            const yRate = parseFloat(els.yRate.value);
            const yMapped = parseFloat(els.yMapped.textContent);
            let yPwm = yZero + yRate * yMapped;
            const yMin = parseFloat(els.yMin.value);
            const yMax = parseFloat(els.yMax.value);
            yPwm = Math.max(yMin, Math.min(yMax, yPwm));
            els.yPwm.textContent = yPwm.toFixed(0);
        }

        // 连接WebSocket（ESP32）
        function connectWS() {
            // 替换为ESP32的IP地址
            const esp32Ip = '192.168.4.1'; // ESP32 AP模式默认IP
            const wsUrl = `ws://${esp32Ip}:81`;
            state.ws = new WebSocket(wsUrl);

            state.ws.onopen = () => {
                addDebug(`WebSocket连接成功：${wsUrl}`);
                els.wifiInfo.textContent = `ESP32-AP / ${esp32Ip}`;
            };

            state.ws.onclose = () => {
                addDebug('WebSocket连接断开，5秒后重连');
                els.wifiInfo.textContent = `未连接 / -`;
                setTimeout(connectWS, 5000);
            };

            state.ws.onerror = (err) => {
                addDebug(`WebSocket错误：${err}`);
            };

            state.ws.onmessage = (e) => {
                // 计算延迟
                state.delay = Date.now() - state.lastSendTime;
                addDebug(`收到ESP32响应：${e.data}，延迟：${state.delay}ms`);
            };
        }

        // 下发数据到ESP32
        function sendToESP32() {
            if (!state.ctrlEnabled || !state.ws || state.ws.readyState !== WebSocket.OPEN) return;

            // 构造JSON数据
            const data = {
                'P-PIN': parseInt(els.pPin.value),
                'P-PWM': parseInt(els.pPwm.textContent),
                'R-PIN': parseInt(els.rPin.value),
                'R-PWM': parseInt(els.rPwm.textContent),
                'Y-PIN': parseInt(els.yPin.value),
                'Y-PWM': parseInt(els.yPwm.textContent)
            };

            // 发送数据
            state.lastSendTime = Date.now();
            state.ws.send(JSON.stringify(data));

            // 统计码率
            state.sendCount++;
            const now = Date.now();
            if (now - state.lastRateTime >= 1000) {
                const rate = state.sendCount;
                state.sendCount = 0;
                state.lastRateTime = now;
                // 更新界面信息
                els.uiInfo.textContent = `- / ${rate}Hz / ${state.delay}ms`;
                addDebug(`码率：${rate}Hz，延迟：${state.delay}ms`);
            }
        }

        // 添加调试信息
        function addDebug(msg) {
            const time = new Date().toLocaleTimeString();
            const newMsg = `[${time}] ${msg}\n`;
            els.debugContent.textContent += newMsg;
            // 只保留最近10条
            const lines = els.debugContent.textContent.split('\n');
            if (lines.length > 10) {
                els.debugContent.textContent = lines.slice(-10).join('\n');
            }
        }

        // 初始化
        window.onload = () => {
            initBrowserInfo();
            initSwitches();
            initResetBtn();
            connectWS();
            addDebug('页面初始化完成');
        };
    </script>
</body>
</html>
