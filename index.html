<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>陀螺仪</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { background: white; padding: 20px; border-radius: 10px; text-align: center; }
        .data { margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; }
        .value { font-weight: bold; color: #007bff; font-size: 24px; }
        .status { color: #dc3545; font-weight: bold; margin: 10px 0; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:disabled { background: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <h2>陀螺仪</h2>
        <div id="status" class="status">点击启动</div>
        <button id="startBtn">启动陀螺仪</button>
        
        <div class="data">俯仰角：<span id="pitch" class="value">3600</span>°</div>
        <div class="data">横滚角：<span id="roll" class="value">3600</span>°</div>
        <div class="data">偏航角：<span id="yaw" class="value">3600</span>°</div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const startBtn = document.getElementById('startBtn');
        
        // 1. 累计角度（初始3600，轴完全独立）
        let pitchTotal = 3600;
        let rollTotal = 3600;
        let yawTotal = 3600;
        
        // 2. 上一次原始值（每个轴独立缓存）
        let prevBeta = null;
        let prevGamma = null;
        let prevAlpha = null;
        
        // 3. 核心阈值配置（彻底过滤耦合干扰）
        const CONFIG = {
            pitch: {
                shakeThreshold: 1.0,    // 防抖阈值（过滤<1°的耦合偏移）
                validDelta: 1.5,        // 有效变化阈值（仅>1.5°才累计）
                maxRange: 360,          // 原始值总范围
                jumpThreshold: 180      // 跳变判定阈值
            },
            roll: {
                shakeThreshold: 1.0,
                validDelta: 1.5,
                maxRange: 180,
                jumpThreshold: 90
            },
            yaw: {
                shakeThreshold: 1.0,
                validDelta: 1.5,
                maxRange: 360,
                jumpThreshold: 180
            }
        };

        /**
         * 精准修正角度跳变（区分增大/减小方向）
         * @param {Object} axisConfig 轴配置（防抖/有效阈值等）
         * @param {number} current 当前原始值
         * @param {number} previous 上一次原始值
         * @returns {number} 仅返回“有效且非耦合”的差值
         */
        function calculateValidDelta(axisConfig, current, previous) {
            // 首次无差值/差值过小（防抖）→ 返回0
            if (previous === null || Math.abs(current - previous) < axisConfig.shakeThreshold) {
                return 0;
            }

            let delta = current - previous;
            // 修正跳变（精准区分增大/减小方向）
            if (Math.abs(delta) > axisConfig.jumpThreshold) {
                delta = delta > 0 ? (delta - axisConfig.maxRange) : (delta + axisConfig.maxRange);
            }

            // 仅当差值超过有效阈值时，才返回真实差值（否则返回0）
            return Math.abs(delta) >= axisConfig.validDelta ? delta : 0;
        }

        function startGyro() {
            if (!window.DeviceOrientationEvent) {
                statusEl.textContent = '设备不支持';
                return;
            }
            
            statusEl.textContent = '启动中...';
            startBtn.disabled = true;
            
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        startSensors();
                    } else {
                        statusEl.textContent = '权限被拒绝';
                        startBtn.disabled = false;
                    }
                }).catch(() => {
                    statusEl.textContent = '权限请求失败';
                    startBtn.disabled = false;
                });
            } else {
                startSensors();
            }
        }
        
        function startSensors() {
            let hasData = false;
            
            window.addEventListener('deviceorientation', (event) => {
                // 原始值（兜底0，避免null）
                const beta = event.beta ?? 0;     // 俯仰：-180 ~ 180
                const gamma = event.gamma ?? 0;   // 横滚：-90 ~ 90
                const alpha = event.alpha ?? 0;   // 偏航：0 ~ 360

                // 首次初始化：仅缓存原始值，不计算差值
                if (!hasData) {
                    prevBeta = beta;
                    prevGamma = gamma;
                    prevAlpha = alpha;
                    hasData = true;
                    statusEl.textContent = '数据读取中';
                    return;
                }

                // ========== 俯仰轴（100%独立，完全过滤横滚耦合） ==========
                const pitchDelta = calculateValidDelta(CONFIG.pitch, beta, prevBeta);
                if (pitchDelta !== 0) {
                    // 额外判定：仅当俯仰变化远大于横滚变化时，才累计（彻底解耦）
                    const rollTempDelta = Math.abs(gamma - prevGamma);
                    if (Math.abs(pitchDelta) > rollTempDelta * 2) {
                        pitchTotal += pitchDelta;
                        prevBeta = beta; // 仅更新俯仰缓存
                        document.getElementById('pitch').textContent = pitchTotal.toFixed(1);
                    }
                }

                // ========== 横滚轴（100%独立，完全过滤俯仰耦合） ==========
                const rollDelta = calculateValidDelta(CONFIG.roll, gamma, prevGamma);
                if (rollDelta !== 0) {
                    // 额外判定：仅当横滚变化远大于俯仰变化时，才累计（彻底解耦）
                    const pitchTempDelta = Math.abs(beta - prevBeta);
                    if (Math.abs(rollDelta) > pitchTempDelta * 2) {
                        rollTotal += rollDelta;
                        prevGamma = gamma; // 仅更新横滚缓存
                        document.getElementById('roll').textContent = rollTotal.toFixed(1);
                    }
                }

                // ========== 偏航轴（独立无干扰） ==========
                const yawDelta = calculateValidDelta(CONFIG.yaw, alpha, prevAlpha);
                if (yawDelta !== 0) {
                    yawTotal += yawDelta;
                    prevAlpha = alpha;
                    document.getElementById('yaw').textContent = yawTotal.toFixed(1);
                }
            });
            
            // 启动超时重试
            setTimeout(() => {
                if (!hasData) {
                    statusEl.textContent = '启动失败，请重试';
                    startBtn.disabled = false;
                    startBtn.textContent = '重试';
                }
            }, 3000);
        }
        
        // 绑定启动事件
        startBtn.addEventListener('click', startGyro);
    </script>
</body>
</html>
