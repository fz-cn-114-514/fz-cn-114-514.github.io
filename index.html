<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ESP32 3轴舵机控制</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 10px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 24px;
        }
        
        /* 开关样式 */
        .switch-group {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 15px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .switch-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
        }
        
        .switch-label {
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 70px;
            height: 36px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 36px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 28px;
            width: 28px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        input:checked + .slider {
            background-color: #28a745;
        }
        
        input:checked + .slider:before {
            transform: translateX(34px);
        }
        
        .slider .on-text {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: bold;
            color: #666;
            transition: .3s;
        }
        
        .slider .off-text {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: bold;
            color: #666;
            transition: .3s;
        }
        
        input:checked + .slider .on-text {
            color: white;
        }
        
        input:checked + .slider .off-text {
            color: white;
        }
        
        /* 按钮样式 */
        .btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .btn:active {
            background: #dc3545;
            transform: scale(0.95);
        }
        
        /* 轴配置区域 */
        .axis-section {
            background: white;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .axis-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #007bff;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .param-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .param-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .param-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 5px;
            text-align: center;
            font-weight: bold;
        }
        
        .param-value {
            background: #f8f9fa;
            padding: 8px 10px;
            border-radius: 5px;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
            font-size: 14px;
            border: 1px solid #dee2e6;
        }
        
        .param-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            text-align: center;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .param-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        /* 状态区域 */
        .status-section {
            background: white;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .status-section h3 {
            color: #007bff;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: bold;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 8px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid #007bff;
        }
        
        .status-label {
            font-size: 13px;
            color: #666;
            font-weight: bold;
        }
        
        .status-value {
            font-weight: bold;
            font-size: 13px;
        }
        
        .status-value.connected {
            color: #28a745;
        }
        
        .status-value.disconnected {
            color: #dc3545;
        }
        
        .status-value.enabled {
            color: #28a745;
        }
        
        .status-value.disabled {
            color: #dc3545;
        }
        
        /* 说明区域 */
        .info-section {
            background: white;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .info-section h3 {
            color: #007bff;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: bold;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 8px;
        }
        
        .info-section ul {
            padding-left: 20px;
        }
        
        .info-section li {
            margin-bottom: 6px;
            font-size: 13px;
            line-height: 1.5;
        }
        
        /* 调试区域 */
        .debug-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 250px;
            overflow-y: auto;
        }
        
        .debug-section h3 {
            color: #007bff;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: bold;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 8px;
        }
        
        #debugLog {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.4;
            background: #1e1e1e;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .debug-line {
            margin-bottom: 3px;
            word-wrap: break-word;
        }
        
        .debug-time {
            color: #888;
            margin-right: 8px;
        }
        
        /* 锁定状态 */
        .locked {
            pointer-events: none;
            opacity: 0.4;
            filter: grayscale(50%);
        }
        
        /* 响应式设计 */
        @media (max-width: 600px) {
            .switch-group {
                flex-direction: column;
            }
            
            .switch-item {
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
                padding: 5px 0;
            }
            
            .switch-label {
                margin-bottom: 0;
                margin-right: 10px;
            }
            
            .param-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ESP32 3轴舵机控制</h1>
        
        <!-- 控制开关 -->
        <div class="switch-group" id="controlPanel">
            <div class="switch-item">
                <div class="switch-label">启用控制</div>
                <label class="switch">
                    <input type="checkbox" id="enableControl" checked>
                    <span class="slider">
                        <span class="off-text">OFF</span>
                        <span class="on-text">ON</span>
                    </span>
                </label>
            </div>
            
            <div class="switch-item">
                <div class="switch-label">操作解锁</div>
                <label class="switch">
                    <input type="checkbox" id="unlockOperation" checked>
                    <span class="slider">
                        <span class="off-text">OFF</span>
                        <span class="on-text">ON</span>
                    </span>
                </label>
            </div>
            
            <div class="switch-item">
                <div class="switch-label">陀螺仪开关</div>
                <label class="switch">
                    <input type="checkbox" id="gyroSwitch">
                    <span class="slider">
                        <span class="off-text">OFF</span>
                        <span class="on-text">ON</span>
                    </span>
                </label>
            </div>
            
            <button class="btn" id="resetMapping">映射归零</button>
        </div>
        
        <!-- 俯仰角配置 -->
        <div class="axis-section" id="pitchSection">
            <div class="axis-title">俯仰角 (Pitch)</div>
            <div class="param-grid">
                <div class="param-item">
                    <div class="param-label">传感器原始数据</div>
                    <div class="param-value" id="pitchRaw">0.0°</div>
                </div>
                <div class="param-item">
                    <div class="param-label">映射角度</div>
                    <div class="param-value" id="pitchMapped">0.0°</div>
                </div>
                <div class="param-item">
                    <div class="param-label">映射引脚</div>
                    <input type="number" class="param-input" id="pitchPin" value="12" min="0" max="39">
                </div>
                <div class="param-item">
                    <div class="param-label">每度脉宽 (Rate)</div>
                    <input type="number" class="param-input" id="pitchRate" value="10.00" step="0.01" min="-20" max="20">
                </div>
            </div>
            <div class="param-grid">
                <div class="param-item">
                    <div class="param-label">最小脉宽</div>
                    <input type="number" class="param-input" id="pitchMin" value="500" min="0" max="4095">
                </div>
                <div class="param-item">
                    <div class="param-label">当前脉宽</div>
                    <div class="param-value" id="pitchPwm">1500us</div>
                </div>
                <div class="param-item">
                    <div class="param-label">0度对应脉宽</div>
                    <input type="number" class="param-input" id="pitchZero" value="1500" min="0" max="4095">
                </div>
                <div class="param-item">
                    <div class="param-label">最大脉宽</div>
                    <input type="number" class="param-input" id="pitchMax" value="2500" min="0" max="4095">
                </div>
            </div>
        </div>
        
        <!-- 横滚角配置 -->
        <div class="axis-section" id="rollSection">
            <div class="axis-title">横滚角 (Roll)</div>
            <div class="param-grid">
                <div class="param-item">
                    <div class="param-label">传感器原始数据</div>
                    <div class="param-value" id="rollRaw">0.0°</div>
                </div>
                <div class="param-item">
                    <div class="param-label">映射角度</div>
                    <div class="param-value" id="rollMapped">0.0°</div>
                </div>
                <div class="param-item">
                    <div class="param-label">映射引脚</div>
                    <input type="number" class="param-input" id="rollPin" value="13" min="0" max="39">
                </div>
                <div class="param-item">
                    <div class="param-label">每度脉宽 (Rate)</div>
                    <input type="number" class="param-input" id="rollRate" value="10.00" step="0.01" min="-20" max="20">
                </div>
            </div>
            <div class="param-grid">
                <div class="param-item">
                    <div class="param-label">最小脉宽</div>
                    <input type="number" class="param-input" id="rollMin" value="500" min="0" max="4095">
                </div>
                <div class="param-item">
                    <div class="param-label">当前脉宽</div>
                    <div class="param-value" id="rollPwm">1500us</div>
                </div>
                <div class="param-item">
                    <div class="param-label">0度对应脉宽</div>
                    <input type="number" class="param-input" id="rollZero" value="1500" min="0" max="4095">
                </div>
                <div class="param-item">
                    <div class="param-label">最大脉宽</div>
                    <input type="number" class="param-input" id="rollMax" value="2500" min="0" max="4095">
                </div>
            </div>
        </div>
        
        <!-- 偏航角配置 -->
        <div class="axis-section" id="yawSection">
            <div class="axis-title">偏航角 (Yaw)</div>
            <div class="param-grid">
                <div class="param-item">
                    <div class="param-label">传感器原始数据</div>
                    <div class="param-value" id="yawRaw">0.0°</div>
                </div>
                <div class="param-item">
                    <div class="param-label">映射角度</div>
                    <div class="param-value" id="yawMapped">0.0°</div>
                </div>
                <div class="param-item">
                    <div class="param-label">映射引脚</div>
                    <input type="number" class="param-input" id="yawPin" value="14" min="0" max="39">
                </div>
                <div class="param-item">
                    <div class="param-label">每度脉宽 (Rate)</div>
                    <input type="number" class="param-input" id="yawRate" value="10.00" step="0.01" min="-20" max="20">
                </div>
            </div>
            <div class="param-grid">
                <div class="param-item">
                    <div class="param-label">最小脉宽</div>
                    <input type="number" class="param-input" id="yawMin" value="500" min="0" max="4095">
                </div>
                <div class="param-item">
                    <div class="param-label">当前脉宽</div>
                    <div class="param-value" id="yawPwm">1500us</div>
                </div>
                <div class="param-item">
                    <div class="param-label">0度对应脉宽</div>
                    <input type="number" class="param-input" id="yawZero" value="1500" min="0" max="4095">
                </div>
                <div class="param-item">
                    <div class="param-label">最大脉宽</div>
                    <input type="number" class="param-input" id="yawMax" value="2500" min="0" max="4095">
                </div>
            </div>
        </div>
        
        <!-- 网页状态参数 -->
        <div class="status-section">
            <h3>网页状态参数</h3>
            <div class="status-grid">
                <div class="status-item">
                    <span class="status-label">WiFi名称:</span>
                    <span class="status-value" id="wifiSSID">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">WiFi IP:</span>
                    <span class="status-value" id="wifiIP">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">WiFi MAC:</span>
                    <span class="status-value" id="wifiMAC">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">WebSocket状态:</span>
                    <span class="status-value disconnected" id="wsStatus">未连接</span>
                </div>
                <div class="status-item">
                    <span class="status-label">浏览器内核:</span>
                    <span class="status-value" id="browserEngine">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">陀螺仪状态:</span>
                    <span class="status-value disabled" id="sensorStatus">已关闭</span>
                </div>
                <div class="status-item">
                    <span class="status-label">界面锁定:</span>
                    <span class="status-value disabled" id="lockStatus">已解锁</span>
                </div>
                <div class="status-item">
                    <span class="status-label">实时码率:</span>
                    <span class="status-value" id="updateRate">0 Hz</span>
                </div>
                <div class="status-item">
                    <span class="status-label">实时延迟:</span>
                    <span class="status-value" id="latency">0 ms</span>
                </div>
                <div class="status-item">
                    <span class="status-label">控制状态:</span>
                    <span class="status-value enabled" id="controlStatus">已启用</span>
                </div>
            </div>
        </div>
        
        <!-- 使用说明 -->
        <div class="info-section">
            <h3>使用说明</h3>
            <ul>
                <li><strong>启用控制：</strong>开启/关闭陀螺仪对舵机的控制，默认ON</li>
                <li><strong>操作解锁：</strong>防止误触，解锁后可调整参数，默认ON；OFF时除了本开关界面中任何地方都不可操作</li>
                <li><strong>陀螺仪开关：</strong>开启/关闭陀螺仪数据读取，默认OFF；ON替代原本网页上的"启动陀螺仪"</li>
                <li><strong>映射归零：</strong>将当前传感器值设为0度基准。例如：当前俯仰原始数值是3645度，点击"映射归零"后映射角度变为0度；传感器变成3660度时映射角度变为15度</li>
                <li><strong>输出脉宽计算：</strong>输出脉宽 = 0度脉宽 + rate × 映射角度。例如rate=5.55时，映射角度0度输出1500us，180度输出约2500us，-180度输出约500us</li>
                <li><strong>Rate参数：</strong>表示在0度脉宽的基础上与映射角度的乘数，负值时通道反转映射，默认10</li>
                <li><strong>初始值：</strong>初始值仅用于姿态归零得到映射角度，不参与实际舵机控制。参与舵机控制的只是rate和映射角度</li>
            </ul>
        </div>
        
        <!-- 注意事项 -->
        <div class="info-section">
            <h3>注意事项</h3>
            <ul>
                <li>确保ESP32已正确连接舵机，舵机电源充足</li>
                <li>首次使用请先进行映射归零，建立正确的零点基准</li>
                <li>调整参数时建议先关闭控制，避免舵机意外动作</li>
                <li>避免将脉宽设置超出舵机承受范围（通常500-2500us）</li>
                <li>传感器数据可能受环境影响，建议在稳定环境下使用</li>
                <li>本页面需要HTTPS环境才能访问陀螺仪传感器（iOS限制）</li>
                <li>连接ESP32热点后，手动输入ESP32的IP地址或使用部署的GitHub Pages页面</li>
                <li>保持手机与ESP32的稳定连接，避免频繁断开重连</li>
            </ul>
        </div>
        
        <!-- 调试日志 -->
        <div class="debug-section">
            <h3>调试信息</h3>
            <div id="debugLog"></div>
        </div>
    </div>
    
    <script>
        // DOM元素
        const enableControl = document.getElementById('enableControl');
        const unlockOperation = document.getElementById('unlockOperation');
        const gyroSwitch = document.getElementById('gyroSwitch');
        const resetMapping = document.getElementById('resetMapping');
        
        const wsStatus = document.getElementById('wsStatus');
        const sensorStatus = document.getElementById('sensorStatus');
        const controlStatus = document.getElementById('controlStatus');
        const lockStatus = document.getElementById('lockStatus');
        const updateRateEl = document.getElementById('updateRate');
        const latencyEl = document.getElementById('latency');
        
        const wifiSSID = document.getElementById('wifiSSID');
        const wifiIP = document.getElementById('wifiIP');
        const wifiMAC = document.getElementById('wifiMAC');
        const browserEngine = document.getElementById('browserEngine');
        
        const debugLog = document.getElementById('debugLog');
        const controlPanel = document.getElementById('controlPanel');
        const pitchSection = document.getElementById('pitchSection');
        const rollSection = document.getElementById('rollSection');
        const yawSection = document.getElementById('yawSection');
        
        // WebSocket
        let ws;
        let wsConnected = false;
        let esp32IP = '';
        
        // 状态管理
        let sensorEnabled = false;
        let controlEnabled = true;
        let operationUnlocked = true;
        
        // 性能统计
        let updateCount = 0;
        let lastUpdateTime = 0;
        let updateInterval = 0;
        
        // 映射基准值
        const mappingBase = {
            pitch: 0,
            roll: 0,
            yaw: 0
        };
        
        // 核心状态管理
        const axisState = {
            pitch: {
                total: 3600, prev: null, trend: [], lock: false, speed: 0
            },
            roll: {
                total: 3600, prev: null, trend: [], lock: false, speed: 0,
                baseValue: 0, lastDir: 0, roundTrip: false, tripOffset: 0
            },
            yaw: {
                total: 3600, prev: null, trend: [], lock: false, speed: 0
            }
        };
        
        // 动态配置
        const DYNAMIC_CONFIG = {
            fastSpeed: 2.0, slowThreshold: 0.3, fastThreshold: 1.0,
            trendLength: 5, trendValid: 3,
            roll: {
                jumpThreshold: 90, maxRange: 180,
                roundTripThreshold: 80,
                lockOthers: true
            },
            pitch: { jumpThreshold: 180, maxRange: 360 },
            yaw: { jumpThreshold: 180, maxRange: 360 }
        };
        
        // 调试日志函数
        function logDebug(message) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { hour12: false });
            const logLine = `<div class="debug-line"><span class="debug-time">[${timeStr}]</span>${message}</div>`;
            debugLog.innerHTML += logLine;
            debugLog.scrollTop = debugLog.scrollHeight;
            
            // 限制日志行数
            while (debugLog.children.length > 100) {
                debugLog.removeChild(debugLog.firstChild);
            }
        }
        
        // 获取浏览器信息
        function getBrowserInfo() {
            const ua = navigator.userAgent;
            let engine = 'Unknown';
            
            if (ua.indexOf('Chrome') > -1) {
                engine = 'Chrome/' + ua.match(/Chrome\/(\d+)/)?.[1] || 'Unknown';
            } else if (ua.indexOf('Firefox') > -1) {
                engine = 'Firefox/' + ua.match(/Firefox\/(\d+)/)?.[1] || 'Unknown';
            } else if (ua.indexOf('Safari') > -1) {
                engine = 'Safari/' + ua.match(/Version\/(\d+)/)?.[1] || 'Unknown';
            } else if (ua.indexOf('Edge') > -1) {
                engine = 'Edge/' + ua.match(/Edge\/(\d+)/)?.[1] || 'Unknown';
            }
            
            return engine;
        }
        
        // WebSocket连接
        function connectWebSocket() {
            if (!esp32IP) {
                logDebug('请先输入ESP32 IP地址');
                return;
            }
            
            const wsUrl = `ws://${esp32IP}/ws`;
            logDebug(`连接WebSocket: ${wsUrl}`);
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                wsConnected = true;
                wsStatus.textContent = '已连接';
                wsStatus.className = 'status-value connected';
                logDebug('WebSocket连接成功');
                
                // 请求ESP32状态
                fetch(`http://${esp32IP}/status`)
                    .then(res => res.json())
                    .then(data => {
                        wifiSSID.textContent = data.ap_ssid || '-';
                        wifiIP.textContent = data.ap_ip || '-';
                        wifiMAC.textContent = data.ap_mac || '-';
                        logDebug(`ESP32状态: ${JSON.stringify(data)}`);
                    })
                    .catch(err => {
                        logDebug(`获取ESP32状态失败: ${err.message}`);
                    });
            };
            
            ws.onclose = () => {
                wsConnected = false;
                wsStatus.textContent = '未连接';
                wsStatus.className = 'status-value disconnected';
                logDebug('WebSocket连接关闭');
                // 3秒后重连
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = (error) => {
                logDebug(`WebSocket错误`);
            };
        }
        
        // 发送PWM数据到ESP32
        function sendPwmData() {
            if (!wsConnected || !controlEnabled) return;
            
            const pitchPin = parseInt(document.getElementById('pitchPin').value);
            const rollPin = parseInt(document.getElementById('rollPin').value);
            const yawPin = parseInt(document.getElementById('yawPin').value);
            
            const pitchPwm = parseInt(document.getElementById('pitchPwm').textContent);
            const rollPwm = parseInt(document.getElementById('rollPwm').textContent);
            const yawPwm = parseInt(document.getElementById('yawPwm').textContent);
            
            const data = `{P-PIN:${pitchPin};P-PWM:${pitchPwm};R-PIN:${rollPin};R-PWM:${rollPwm};Y-PIN:${yawPin};Y-PWM:${yawPwm}}`;
            
            ws.send(data);
            
            // 更新性能统计
            const now = Date.now();
            if (lastUpdateTime > 0) {
                updateInterval = now - lastUpdateTime;
                updateCount++;
                
                if (updateCount % 10 === 0) {
                    const rate = Math.round(1000 / updateInterval);
                    updateRateEl.textContent = `${rate} Hz`;
                    latencyEl.textContent = `${updateInterval} ms`;
                }
            }
            lastUpdateTime = now;
        }
        
        // 横滚轴专属跳变修正
        function correctRollDelta(current, prev, rollState) {
            if (prev === null) return 0;
            
            let delta = current - prev;
            if (Math.abs(delta) > DYNAMIC_CONFIG.roll.jumpThreshold) {
                delta = current < prev ? 180 : -180;
                
                if (rollState.lastDir !== 0 && Math.sign(delta) !== rollState.lastDir) {
                    rollState.roundTrip = true;
                    rollState.tripOffset += delta;
                }
                rollState.lastDir = Math.sign(delta);
            }
            
            if (rollState.roundTrip && Math.abs(current - rollState.baseValue) < 10) {
                delta -= rollState.tripOffset;
                rollState.roundTrip = false;
                rollState.tripOffset = 0;
                rollState.lastDir = 0;
            }
            return delta;
        }
        
        // 通用跳变修正
        function correctNormalDelta(axis, current, prev) {
            if (prev === null) return 0;
            const cfg = DYNAMIC_CONFIG[axis];
            
            let delta = current - prev;
            if (Math.abs(delta) > cfg.jumpThreshold) {
                delta = delta > 0 ? delta - cfg.maxRange : delta + cfg.maxRange;
            }
            return delta;
        }
        
        // 5取3趋势判定
        function getConsistentTrend(trend) {
            if (trend.length < DYNAMIC_CONFIG.trendLength) return 0;
            const up = trend.filter(t => t === 1).length;
            const down = trend.filter(t => t === -1).length;
            if (up >= DYNAMIC_CONFIG.trendValid) return 1;
            if (down >= DYNAMIC_CONFIG.trendValid) return -1;
            return 0;
        }
        
        // 更新显示值
        function updateDisplay(axis, rawValue, mappedValue, pwm) {
            document.getElementById(`${axis}Raw`).textContent = `${rawValue.toFixed(1)}°`;
            document.getElementById(`${axis}Mapped`).textContent = `${mappedValue.toFixed(1)}°`;
            document.getElementById(`${axis}Pwm`).textContent = `${pwm}us`;
        }
        
        // 计算并发送PWM
        function calculateAndSendPwm(axis, mappedAngle) {
            if (!controlEnabled) return;
            
            const pin = parseInt(document.getElementById(`${axis}Pin`).value);
            const rate = parseFloat(document.getElementById(`${axis}Rate`).value);
            const zeroPwm = parseInt(document.getElementById(`${axis}Zero`).value);
            const minPwm = parseInt(document.getElementById(`${axis}Min`).value);
            const maxPwm = parseInt(document.getElementById(`${axis}Max`).value);
            
            // 计算输出脉宽
            let pwm = zeroPwm + rate * mappedAngle;
            
            // 限制范围
            pwm = Math.max(minPwm, Math.min(maxPwm, pwm));
            pwm = Math.round(pwm);
            
            // 更新显示
            updateDisplay(axis, axisState[axis].total, mappedAngle, pwm);
            
            // 发送到ESP32
            sendPwmData();
        }
        
        // 处理横滚轴
        function processRoll(current) {
            const state = axisState.roll;
            if (state.prev === null) {
                state.baseValue = current;
                state.prev = current;
                return;
            }
            
            const delta = correctRollDelta(current, state.prev, state);
            state.speed = Math.abs(delta);
            const threshold = state.speed > DYNAMIC_CONFIG.fastSpeed 
                ? DYNAMIC_CONFIG.fastThreshold 
                : DYNAMIC_CONFIG.slowThreshold;
            
            if (Math.abs(delta) < threshold) {
                state.trend = [];
                if (DYNAMIC_CONFIG.roll.lockOthers) {
                    axisState.pitch.lock = false;
                    axisState.yaw.lock = false;
                }
                return;
            }
            
            if (DYNAMIC_CONFIG.roll.lockOthers) {
                axisState.pitch.lock = true;
                axisState.yaw.lock = true;
            }
            
            state.trend.push(delta > 0 ? 1 : -1);
            if (state.trend.length > DYNAMIC_CONFIG.trendLength) state.trend.shift();
            const trend = getConsistentTrend(state.trend);
            if (trend === 0) return;
            
            state.total += delta;
            state.prev = current;
            
            // 计算映射角度
            const mappedAngle = state.total - mappingBase.roll;
            calculateAndSendPwm('roll', mappedAngle);
        }
        
        // 处理俯仰/偏航轴
        function processNormalAxis(axis, current) {
            const state = axisState[axis];
            if (state.lock) return;
            
            const delta = correctNormalDelta(axis, current, state.prev);
            state.speed = Math.abs(delta);
            const threshold = state.speed > DYNAMIC_CONFIG.fastSpeed 
                ? DYNAMIC_CONFIG.fastThreshold 
                : DYNAMIC_CONFIG.slowThreshold;
            
            if (Math.abs(delta) < threshold) {
                state.trend = [];
                return;
            }
            
            state.trend.push(delta > 0 ? 1 : -1);
            if (state.trend.length > DYNAMIC_CONFIG.trendLength) state.trend.shift();
            const trend = getConsistentTrend(state.trend);
            if (trend === 0) return;
            
            state.total += delta;
            state.prev = current;
            
            // 计算映射角度
            const mappedAngle = state.total - mappingBase[axis];
            calculateAndSendPwm(axis, mappedAngle);
        }
        
        // 设备方向事件处理
        function handleDeviceOrientation(event) {
            const beta = event.beta ?? 0;
            const gamma = event.gamma ?? 0;
            const alpha = event.alpha ?? 0;
            
            // 初始化
            if (axisState.pitch.prev === null) {
                axisState.pitch.prev = beta;
                axisState.roll.prev = gamma;
                axisState.roll.baseValue = gamma;
                axisState.yaw.prev = alpha;
                
                // 设置初始映射基准
                mappingBase.pitch = axisState.pitch.total;
                mappingBase.roll = axisState.roll.total;
                mappingBase.yaw = axisState.yaw.total;
                
                logDebug('传感器初始化完成');
            }
            
            // 处理数据
            processRoll(gamma);
            processNormalAxis('pitch', beta);
            processNormalAxis('yaw', alpha);
        }
        
        // 启动陀螺仪
        function startGyro() {
            if (!window.DeviceOrientationEvent) {
                logDebug('设备不支持DeviceOrientationEvent');
                return;
            }
            
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        enableSensor();
                    } else {
                        logDebug('陀螺仪权限被拒绝');
                    }
                }).catch(error => {
                    logDebug(`陀螺仪权限请求失败: ${error.message}`);
                });
            } else {
                enableSensor();
            }
        }
        
        // 启用传感器
        function enableSensor() {
            window.addEventListener('deviceorientation', handleDeviceOrientation);
            sensorEnabled = true;
            sensorStatus.textContent = '已开启';
            sensorStatus.className = 'status-value enabled';
            logDebug('陀螺仪已开启');
        }
        
        // 禁用传感器
        function disableSensor() {
            window.removeEventListener('deviceorientation', handleDeviceOrientation);
            sensorEnabled = false;
            sensorStatus.textContent = '已关闭';
            sensorStatus.className = 'status-value disabled';
            logDebug('陀螺仪已关闭');
        }
        
        // 映射归零
        function resetMappingFunc() {
            mappingBase.pitch = axisState.pitch.total;
            mappingBase.roll = axisState.roll.total;
            mappingBase.yaw = axisState.yaw.total;
            logDebug('映射归零完成');
        }
        
        // 切换操作锁定
        function toggleLock() {
            operationUnlocked = unlockOperation.checked;
            
            if (operationUnlocked) {
                pitchSection.classList.remove('locked');
                rollSection.classList.remove('locked');
                yawSection.classList.remove('locked');
                resetMapping.classList.remove('locked');
                lockStatus.textContent = '已解锁';
                lockStatus.className = 'status-value disabled';
                logDebug('操作已解锁');
            } else {
                pitchSection.classList.add('locked');
                rollSection.classList.add('locked');
                yawSection.classList.add('locked');
                resetMapping.classList.add('locked');
                lockStatus.textContent = '已锁定';
                lockStatus.className = 'status-value enabled';
                logDebug('操作已锁定');
            }
        }
        
        // 事件监听
        enableControl.addEventListener('change', () => {
            controlEnabled = enableControl.checked;
            if (controlEnabled) {
                controlStatus.textContent = '已启用';
                controlStatus.className = 'status-value enabled';
                logDebug('控制已启用');
            } else {
                controlStatus.textContent = '已禁用';
                controlStatus.className = 'status-value disabled';
                logDebug('控制已禁用');
            }
        });
        
        unlockOperation.addEventListener('change', toggleLock);
        
        gyroSwitch.addEventListener('change', () => {
            if (gyroSwitch.checked) {
                startGyro();
            } else {
                disableSensor();
            }
        });
        
        resetMapping.addEventListener('click', resetMappingFunc);
        
        // 初始化
        window.addEventListener('load', () => {
            browserEngine.textContent = getBrowserInfo();
            toggleLock();
            
            // 提示用户输入ESP32 IP
            const inputIP = prompt('请输入ESP32的IP地址（例如：192.168.4.1）', '192.168.4.1');
            if (inputIP) {
                esp32IP = inputIP;
                connectWebSocket();
            } else {
                logDebug('未输入ESP32 IP地址，无法连接');
            }
        });
    </script>
</body>
</html>
